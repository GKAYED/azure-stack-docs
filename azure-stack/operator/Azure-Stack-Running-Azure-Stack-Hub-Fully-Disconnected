---
title: Running Azure Stack Hub in a Fully Disconencted Environment 
description: An overview of considerations arising in running Azure Stack Hub fully disconnected.
author: Gkayed

ms.topic: conceptual
ms.date: 01/18/2022
ms.author: gkayed
ms.reviewer: PatAltimore
ms.lastreviewed: 19/01/2022

# Intent: As an Azure Stack Hub Operator, I want to run Azure Stack Hub fully disconnected so that I can deploy Azure to an environment with no connection to the internet.
# Keyword: Running Azure Stack Hub Fully Disconnected

---

# Running Azure Stack Hub in a fully disconnected environment

## Overview

Azure Stack Hub (ASH) is an extension of Azure that allows customers to run apps on premise and deliver Azure capabilities to the customer’s data centre.

Azure Stack Hub unlocks new capabilities and makes new disconnected or hybrid cloud customer use cases possible. For an overview of Azure Stack Hub please visit [Azure Stack Hub Overview](azure-stack-overview.md).

This article describes the basic considerations for configuring Azure Stack Hub in a fully disconnected environment and provides some guidance for minimum configurations required for Azure Stack Hub to work in the new disconnected environment.

### Use cases for a fully disconnected setup

• Deploy Azure Stack Hub in an environment with no connection to the internet.
• Block data (including usage data) from being sent to Azure.
• Use Azure Stack Hub purely as a private cloud solution deployed to corporate intranet.
• Hybrid cloud scenarios are not possible or allowed.

### Azure Stack Hub available services

Azure Stack Hub supports a subset of Azure services to run on ASH. These services will continue to grow and evolve. Currently, the following core services are available in ASH:
• Compute
• Key Vault
• Storage
• Networking
In addition to these services, some PaaS services are supported:
• SQL and MYSQL DBs
• Azure Functions
• App Service

## Internet and Azure Connectivity

A critical early decision point is to choose whether Azure Stack Hub will have any connection to Azure or will be fully disconnected. This is a one-time decision that must be made at deployment time and will have impact on:
1- Identify store
2- Impaired features
3- Billing model and Licensing
4- Azure Stack Hub Registration
5- Approach for patching and updates
6- Multi tenancy
7- External monitoring

Impact on these items is covered in the below sections of this article.

## Identity store

Active Directory Federation Services (AD FS) is the only supported identity provider for a fully disconnected Azure Stack Hub deployment. This can’t be changed later without redeploying the environment.
AD FS allows identities in an existing AD forest to authenticate with resources in ASH.

In a fully disconnected deployment, AD FS and Graph are configured on Azure Stack Hub for the Authentication and Role Based Access Control (RBAC) parts of identity to work. The RBAC part on a disconnected Azure Stack Hub is handled through Graph which will look up the user account in the existing AD forest using LDAP.

For a detailed description of how to integrate Azure Stack Hub AD FS with the existing datacentre AD FS to create AD FS federation trust please check [Integrate AD FS with your Azure Stack Hub Datacentre](azure-stack-integrate-identity.md).

## Impaired features

At this stage, Azure Stack Hub is still designed to work best in hybrid cloud environments where there is a connection to Azure. There are features that will either be impaired or completely unavailable when running Azure Stack Hub in a fully disconnected mode.

Customers can still choose to connect to Azure at any point and have full control of what data is sent to Azure to meet any regulatory or compliance requirements. This includes any data residency restrictions.

For a detailed list of impaired or unavailable features in Azure Stack Hub as a result of no connection please check [Features that are impaired or unavailable in disconnected deployments](azure-stack-disconnected-deployment.md?view=azs-2102#features-that-are-impaired-or-unavailable-in-disconnected-deployments).

At a high level, any feature that will require a connection to the internet will either be impaired or unavailable. For example:

1- **Virtual Machines:** Virtual Machines with extensions that check internet for latest versions ([DSC](https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/dsc-overview) or [Docker](https://github.com/Azure/azure-docker-extension/blob/master/README.md)) will fail to check for latest versions.
2- **Links with external content:** Documentation links on Azure Stack Hub or remediation alerts that use an internet link will not open.
3- **Marketplace components:** Downloading marketplace components will not work from Azure Stack Hub portal. This can still be achieved through [syndication](https://docs.microsoft.com/en-us/azure-stack/mdc/operator/azure-stack-download-azure-marketplace-item-tca?tabs=az1%2Caz2) (Transfer from a machine with connectivity).
4- **Certificates:** No certificates as certificates will require internet for CRL and OCSP for HTTPS to work.
5- **Key Vault:** Key vault not usable. Requires directory admin to add any app (AD FS).
6- **Visual Studio:** Visual studio cloud discovery doesn’t work and only VS Code or enterprise can be used with (AD FS).
7- **Deployment:** Azure AD accounts can’t be used to manage deployment.
8- **CLI:** Heavily Reduced CLI functionality. Non admins can’t add service principles. Must go to directory admin to add any app.

## Billing model and licensing

A disconnected deployment will require a [capacity-based billing model](https://azure.microsoft.com/mediahandler/files/resourcefiles/azure-stack-hub-licensing-packaging-pricing-guide/Azure%20Stack%20Hub%20Licensing%20Packaging%20and%20Pricing%20Guide.pdf) which requires an enterprise agreement. Capacity-based billing model is based on an Azure Stack Hub capacity plan SKU that is based on the capacity of the system (The number of physical cores in ASH).
A sample of Azure Stack Hub capacity-based billing is shown below. This might change as more services are added/updated.
To check available/assigned cores run this command in PowerShell test-azurestack -include AzsVmPlacement -debug

![Sample capacity based billing based plan for Azure Stack Hub](azure-stack\operator\ASH-Pricing-Capacitybased.png)

## Azure Stack Hub Device registration

In a disconnected deployment, registration is not automated and will require a removable media and a separate device that is connected to Azure.

For step by step instructions for how to register Azure Stack Hub in a fully disconnected please refer to [Register Azure Stack Hub with Azure](azure-stack-registration.md?view=azs-2102&tabs=az1%2Caz2%2Caz3%2Caz4&pivots=state-disconnected).

## Patching an updates

Patching and updating Azure Stack Hub will also need to use a separate device connected to Azure and a removable media.
The update process will involve two steps as follows:

1- Downloading the update package on a connected device.
2- Importing the update package into ASH.

Type of updates supported in a disconnected deployment:

1- Azure Stack Hub software updates.
2- Azure Stack Hub hotfixes.
3- Azure Stack Hub OEM package updates.

For step by step instructions for preparing and importing update packages please refer to [Prepare an Azure Stack Hub update package](azure-stack-update-prepare-package.md?view=azs-2102#download-the-update-package).

## Multitenancy

Multitenancy is not supported in a disconnected deployment as that will require AAD.

## External monitoring

External monitoring solutions must be agentless as it is not possible to install third party agents inside Azure Stack Hub components. The system centre operations manager management pack for Azure Stack Hub supports AD FS and can be downloaded from [here](https://www.microsoft.com/en-us/download/details.aspx?id=55184).

Using Nagios is also possible with 1.2 Azure Stack Hub as Nagios plugin supports AD FS. For step by step instructions for configuring external monitoring on Azure Stack Hub please refer to [Integrate external monitoring solution with Azure Stack Hub](azure-stack-integrate-monitor.md?view=azs-2102&tabs=az).

For instructions for how to connect to external monitoring solutions using syslog forwarding please refer to [Integrate Azure Stack Hub with monitoring solutions using syslog forwarding](zure-stack-integrate-security.md?view=azs-2102).

## DNS integration

In a disconnected deployment, External DNS names will require DNS servers to forward DNS requests. Configuration will be required to integrate DNS servers that host the external DNS zone for ASH with DNS servers that host the parent zone.

For information on how to configure DNS forwarding please refer to [Resolving external DNS names from Azure Stack Hub
](azure-stack-integrate-dns.md?view=azs-2102#resolving-external-dns-names-from-azure-stack-hub).

## Other considerations

### Connecting ASH VMs to Microsoft Sentinel in disconnected mode

Microsoft sentinel makes it possible to monitor VMs running on ASH in one location. This is possible through adding the Azure monitor, update, and config mgmt. extension to Virtual Machines.

In a fully disconnected mode, While the extension might be [syndicated](azure-stack-download-azure-marketplace-item-tca.md?tabs=az1%2Caz2) into ASH marketplace, Regulatory and compliance features available in Azure will be either unavailable or heavily impaired as a result of no connection in Azure.

For information on connecting Azure Stack Hub to Microsoft Sentinel please refer to [Connect Azure Stack Hub virtual machines to Microsoft Sentinel](https://docs.microsoft.com/en-us/azure/sentinel/connect-azure-stack).